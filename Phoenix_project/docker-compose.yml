# Docker Compose for Phoenix Project
version: '3.8'

services:
  
  rabbitmq:
    image: "rabbitmq:3.10-management"
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq/
    networks:
      - phoenix_net

  redis:
    image: "redis:7.0-alpine"
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - phoenix_net

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      celery
        -A worker worker
        --loglevel=INFO
        -Q cognitive_workflow
        -c 1 # (并发数 1)
    depends_on:
      - rabbitmq
      - redis
    env_file:
      - .env # (确保 .env 文件存在)
    networks:
      - phoenix_net
    volumes:
      - .:/app # (将当前目录挂载到 /app)

  api:
    build:
      context: .
      dockerfile: Dockerfile
    
    # 关键修正 (Error 10):
    # Gunicorn 的入口点必须是定义了全局 'app' 实例的文件。
    # 'interfaces.api_server:app' 是错误的，因为 'app' 在类内部。
    # 'api.gateway:app' 是正确的 FastAPI 入口点。
    command: >
      gunicorn
        -k uvicorn.workers.UvicornWorker
        -w 4
        -b 0.0.0.0:8000
        api.gateway:app
        
    ports:
      - "8000:8000"
    depends_on:
      - redis
      - rabbitmq
    env_file:
      - .env
    networks:
      - phoenix_net
    volumes:
      - .:/app

networks:
  phoenix_net:
    driver: bridge

volumes:
  rabbitmq_data:
  redis_data:
